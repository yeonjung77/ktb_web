<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>게시글 상세 - 커뮤니티</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; max-width: 900px; margin: 40px auto; padding: 0 16px; line-height: 1.5; background-color: #f3f7fd; }
    h1 { margin-bottom: 0.4rem; }
    .small { font-size: 12px; color: #6b7280; }
    .card { background: #ffffff; border-radius: 18px; padding: 24px; margin: 20px 0 24px; box-shadow: 0 18px 45px rgba(15, 23, 42, 0.10); border: 1px solid rgba(219, 229, 245, 0.9); }
    .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .post-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .post-meta { display: flex; align-items: center; gap: 8px; }
    .avatar { width: 36px; height: 36px; border-radius: 999px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #4b5563; margin-right: 8px; }
    .author-name { font-weight: 600; }
    .post-actions { display: flex; gap: 8px; }
    .btn-outline { padding: 6px 14px; border-radius: 999px; border: 1px solid #d1d5db; background: white; color: #374151; font-size: 13px; cursor: pointer; }
    .btn-outline:hover { background: #f3f4f6; }
    .divider { border-top: 1px solid #e5e7eb; margin: 16px 0; }
    .post-image {
      width: 100%;
      border-radius: 12px;
      background: #e0edff;
      margin-bottom: 16px;
      padding: 8px;
      box-sizing: border-box;
      text-align: center;
    }
    .post-image img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      display: inline-block;
    }
    .post-content { font-size: 14px; color: #111827; white-space: pre-line; }
    .stats-row { display: flex; gap: 12px; margin: 24px 0 8px; }
    .stat-card { flex: 1; background: #e6f0ff; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; }
    .stat-value { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: #4b5563; }
    .comment-box { margin-top: 24px; border-radius: 12px; background: #f0f5ff; padding: 12px; }
    .comment-box textarea { width: 100%; min-height: 80px; padding: 10px; resize: vertical; box-sizing: border-box; border: none; outline: none; background: transparent; font-size: 14px; }
    .comment-box-footer { display: flex; justify-content: flex-end; border-top: 1px solid #e5e7eb; padding-top: 8px; }
    .btn-primary { padding: 8px 18px; border-radius: 999px; border: none; cursor: pointer; background: linear-gradient(135deg, #7fb5ff, #4f8fea); color: white; font-size: 14px; box-shadow: 0 8px 20px rgba(79, 143, 234, 0.30); transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease; }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; background: #9fbef7; }
    .comments-list { margin-top: 24px; }
    .comment-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; }
    .comment-main { display: flex; }
    .comment-avatar { width: 32px; height: 32px; border-radius: 999px; background: #e5e7eb; margin-right: 8px; }
    .comment-body { font-size: 14px; }
    .comment-author { font-weight: 600; font-size: 13px; }
    .comment-date { font-size: 11px; color: #6b7280; }
    .comment-text { margin-top: 4px; }
    .comment-actions { display: flex; flex-direction: column; gap: 4px; }
    .comment-actions button { padding: 4px 10px; border-radius: 999px; border: 1px solid #d1d5db; background: white; color: #374151; font-size: 12px; cursor: pointer; }

    /* ===== Custom Delete Modal ===== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-box {
      width: 320px;
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .modal-text-main {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .modal-text-sub {
      font-size: 13px;
      color: #555;
      margin-bottom: 16px;
    }

    .modal-btn-row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .modal-btn {
      flex: 1;
      padding: 10px 0;
      margin: 0 4px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-cancel { background: #e5e7eb; color: #374151; }
    .modal-confirm { background: #ff6b6b; color: white; }
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }
    .app-title {
      flex: 1;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.04em;
      color: #6b7280;
    }
    .app-divider {
      height: 1px;
      background-color: #dbe5f5;
      margin-bottom: 12px;
    }
    .back-btn {
      background: #eef3ff;
      border: 1px solid #d1ddff;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 600;
      color: #6b7280;
      transition: background-color 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
    }
    .back-btn:hover {
      background: #e0e9ff;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.12);
      transform: translateY(-1px);
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .avatar-header {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #e0edff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #1f2937;
      cursor: pointer;
      position: relative;
    }
    .avatar-header img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 999px;
    }
    .profile-menu {
      position: absolute;
      top: 40px;
      right: 0;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
      padding: 8px;
      display: none;
      z-index: 20;
      min-width: 140px;
    }
    .profile-menu button {
      width: 100%;
      padding: 6px 10px;
      margin: 2px 0;
      font-size: 13px;
      background-color: #edf2ff;
      color: #111827;
      text-align: left;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="app-header">
    <button class="back-btn" id="back-btn" type="button">&lt;</button>
    <div class="app-title">AI Fashion Insight Engine</div>
    <div class="header-right">
      <div class="avatar-header" id="profile-avatar">
        <img id="profile-avatar-img" alt="프로필 이미지" style="display:none;" />
        <span id="avatar-initial">?</span>
        <div class="profile-menu" id="profile-menu">
          <button id="menu-profile-edit" type="button">회원정보 수정</button>
          <button id="menu-password-edit" type="button">비밀번호 수정</button>
          <button id="menu-logout" type="button">로그아웃</button>
        </div>
      </div>
    </div>
  </div>
  <div class="app-divider"></div>
  <div class="card">
    <div id="post-detail-empty" class="small">게시글 정보를 불러오는 중입니다...</div>
    <div id="post-detail" style="display:none;">
      <div class="post-header">
        <div>
          <div class="post-title" id="detail-title"></div>
          <div class="post-meta">
            <div class="avatar">
              <span id="post-author-initial">?</span>
            </div>
            <div>
              <div class="author-name" id="detail-author">더미 작성자</div>
              <div class="small" id="detail-created-at"></div>
            </div>
          </div>
        </div>
        <div class="post-actions">
          <button id="go-edit-btn" type="button" class="btn-outline">수정</button>
          <button id="delete-post-btn" type="button" class="btn-outline">삭제</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="post-image">
        <img id="post-image" alt="게시글 이미지" />
      </div>

      <div class="post-content" id="detail-content"></div>

      <div class="stats-row">
        <div class="stat-card" id="like-card">
          <div class="stat-value" id="detail-likes">0</div>
          <div class="stat-label">좋아요수</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="detail-views">0</div>
          <div class="stat-label">조회수</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="detail-comments-count">0</div>
          <div class="stat-label">댓글</div>
        </div>
      </div>

      <div class="comment-box">
        <textarea id="new-comment-text" placeholder="댓글을 남겨주세요!"></textarea>
        <div id="comment-error" class="small" style="color:#b91c1c; margin-top:4px;"></div>
        <div class="comment-box-footer">
          <button id="add-comment-btn" type="button" class="btn-primary">댓글 등록</button>
        </div>
      </div>

      <div class="comments-list" id="comments-section">
        <ul id="detail-comments"></ul>
      </div>

      <span id="detail-liked" style="display:none;"></span>
    </div>
  </div>

  <!-- ===== 삭제 확인 모달 ===== -->
  <div id="modal-overlay" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-text-main" id="modal-main-text">정말 삭제하시겠습니까?</div>
      <div class="modal-text-sub" id="modal-sub-text">삭제한 내용은 복구할 수 없습니다.</div>
      <div class="modal-btn-row">
        <button class="modal-btn modal-cancel" id="modal-cancel-btn">취소</button>
        <button class="modal-btn modal-confirm" id="modal-confirm-btn">확인</button>
      </div>
    </div>
  </div>

  <script>
	    const apiBase = "";
	    const urlParams = new URLSearchParams(window.location.search);
	    const postId = urlParams.get("id");
	    const currentEmail = localStorage.getItem("currentEmail") || "guest@example.com";
	    const currentNickname = localStorage.getItem("currentNickname") || "";

    const postDetailEmptyEl = document.getElementById("post-detail-empty");
    const postDetailEl = document.getElementById("post-detail");
    const detailTitleEl = document.getElementById("detail-title");
    const detailAuthorEl = document.getElementById("detail-author");
    const detailCreatedAtEl = document.getElementById("detail-created-at");
    const detailContentEl = document.getElementById("detail-content");
    const detailViewsEl = document.getElementById("detail-views");
    const detailLikesEl = document.getElementById("detail-likes");
    const detailCommentsCountEl = document.getElementById("detail-comments-count");
    const detailCommentsEl = document.getElementById("detail-comments");
    const postImageEl = document.getElementById("post-image");
    const likeCard = document.getElementById("like-card");
    const deletePostBtn = document.getElementById("delete-post-btn");
    const goEditBtn = document.getElementById("go-edit-btn");
    const newCommentText = document.getElementById("new-comment-text");
    const addCommentBtn = document.getElementById("add-comment-btn");
    const backBtn = document.getElementById("back-btn");
    const avatarEl = document.getElementById("profile-avatar");
    const avatarImgEl = document.getElementById("profile-avatar-img");
    const avatarInitialEl = document.getElementById("avatar-initial");
    const profileMenuEl = document.getElementById("profile-menu");
    const menuProfileEditBtn = document.getElementById("menu-profile-edit");
    const menuPasswordEditBtn = document.getElementById("menu-password-edit");
    const menuLogoutBtn = document.getElementById("menu-logout");

    /* ============================
       모달 컨트롤
    ============================== */
    const modalOverlay = document.getElementById("modal-overlay");
    const modalMainText = document.getElementById("modal-main-text");
    const modalSubText = document.getElementById("modal-sub-text");
    const modalCancelBtn = document.getElementById("modal-cancel-btn");
    const modalConfirmBtn = document.getElementById("modal-confirm-btn");

    let modalAction = null;

    function openModal(mainMsg, subMsg, actionFn) {
      modalMainText.textContent = mainMsg;
      modalSubText.textContent = subMsg;
      modalAction = actionFn;
      modalOverlay.style.display = "flex";
    }

    function closeModal() {
      modalOverlay.style.display = "none";
      modalAction = null;
    }

    modalCancelBtn.addEventListener("click", closeModal);
    modalConfirmBtn.addEventListener("click", () => {
      if (modalAction) modalAction();
      closeModal();
    });

    const storedProfileImage = localStorage.getItem("currentProfileImage");
    if (storedProfileImage) {
      avatarImgEl.src = storedProfileImage;
      avatarImgEl.style.display = "block";
      avatarInitialEl.style.display = "none";
    } else {
      avatarInitialEl.textContent = currentEmail ? currentEmail[0].toUpperCase() : "?";
      avatarInitialEl.style.display = "block";
      avatarImgEl.style.display = "none";
    }

    avatarEl.addEventListener("click", (event) => {
      event.stopPropagation();
      const isOpen = profileMenuEl.style.display === "block";
      profileMenuEl.style.display = isOpen ? "none" : "block";
    });

    document.addEventListener("click", () => {
      profileMenuEl.style.display = "none";
    });

    profileMenuEl.addEventListener("click", (event) => {
      event.stopPropagation();
    });

    menuProfileEditBtn.addEventListener("click", () => {
      window.location.href = "/static/profile_edit.html";
    });

    menuPasswordEditBtn.addEventListener("click", () => {
      window.location.href = "/static/password_edit.html";
    });

    menuLogoutBtn.addEventListener("click", () => {
      localStorage.removeItem("currentEmail");
      localStorage.removeItem("currentProfileImage");
      window.location.href = "/static/index.html";
    });

    if (backBtn) {
      backBtn.addEventListener("click", () => {
        window.history.back();
      });
    }

    if (!postId) {
      postDetailEmptyEl.textContent = "id 파라미터가 없습니다. 목록에서 다시 선택해주세요.";
    } else {
      loadPostDetail();
    }

    async function loadPostDetail() {
      postDetailEmptyEl.style.display = "block";
      postDetailEl.style.display = "none";
      detailCommentsEl.innerHTML = "";

      try {
        const res = await fetch(`/posts/${postId}?email=${currentEmail}`);
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          postDetailEmptyEl.textContent = `에러: ${data.detail || "상세 정보를 불러올 수 없습니다."}`;
          return;
        }

        detailTitleEl.textContent = data.title;
        detailAuthorEl.textContent = data.author || "관리자";
        detailCreatedAtEl.textContent = data.created_at || "";
        detailContentEl.textContent = data.content;
        detailViewsEl.textContent = data.views;
        detailLikesEl.textContent = data.likes;
        detailCommentsCountEl.textContent = data.comments_count;

        const authorForInitial = data.author && data.author.trim() ? data.author : "";
        document.getElementById("post-author-initial").textContent =
          authorForInitial ? authorForInitial[0].toUpperCase() : "";

        postImageEl.src = data.image || "";

        (data.comments || []).forEach((c) => {
          const li = document.createElement("li");
          li.className = "comment-item";

          const left = document.createElement("div");
          left.className = "comment-main";

          const avatar = document.createElement("div");
          avatar.className = "comment-avatar";

          const body = document.createElement("div");
          body.className = "comment-body";

          const authorEl = document.createElement("div");
          authorEl.className = "comment-author";
          authorEl.textContent = c.author || "관리자";

          const dateEl = document.createElement("div");
          dateEl.className = "comment-date";
          dateEl.textContent = c.created_at || "";

          const textEl = document.createElement("div");
          textEl.className = "comment-text";
          textEl.textContent = c.text;

          body.appendChild(authorEl);
          body.appendChild(dateEl);
          body.appendChild(textEl);
          left.appendChild(avatar);
          left.appendChild(body);

          const actions = document.createElement("div");
          actions.className = "comment-actions";

          const editBtn = document.createElement("button");
          editBtn.textContent = "수정";
          editBtn.addEventListener("click", () => editComment(c.id, c.text));

          const delBtn = document.createElement("button");
          delBtn.textContent = "삭제";
          delBtn.addEventListener("click", () => deleteComment(c.id));

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          li.appendChild(left);
          li.appendChild(actions);
          detailCommentsEl.appendChild(li);
        });

        postDetailEmptyEl.style.display = "none";
        postDetailEl.style.display = "block";
      } catch (err) {
        console.error(err);
        postDetailEmptyEl.textContent = "네트워크 오류가 발생했습니다.";
      }
    }

    likeCard.addEventListener("click", async () => {
      const form = new FormData();
      form.append("email", currentEmail);

      try {
        const res = await fetch(`/posts/${postId}/like`, { method: "POST", body: form });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return alert(data.detail || "좋아요 처리 중 오류가 발생했습니다.");
        await loadPostDetail();
      } catch (err) {
        console.error(err);
        alert("네트워크 오류가 발생했습니다.");
      }
    });

    /* ============================
       게시글 삭제 버튼 → 모달 실행
    ============================== */
    deletePostBtn.addEventListener("click", () => {
      openModal(
        "게시글을 삭제하시겠습니까?",
        "삭제한 내용은 복구할 수 없습니다",
        async () => {
          try {
            const res = await fetch(`/posts/${postId}`, { method: "DELETE" });
            const data = await res.json().catch(() => ({}));

            if (!res.ok) return alert(data.detail || "삭제 중 오류가 발생했습니다.");

            alert("삭제 완료");
            window.location.href = "/static/posts_list.html";
          } catch (err) {
            console.error(err);
            alert("네트워크 오류가 발생했습니다.");
          }
        }
      );
    });

    goEditBtn.addEventListener("click", () => {
      window.location.href = `/static/post_edit.html?id=${postId}`;
    });

	    /* ============================
	       댓글 작성
	    ============================== */
	    const commentErrorEl = document.getElementById("comment-error");

	    addCommentBtn.addEventListener("click", async () => {
	      const text = newCommentText.value.trim();
	      if (!text) {
	        commentErrorEl.textContent = "댓글 내용을 입력해주세요.";
	        return;
	      }

	      const form = new FormData();
	      form.append("text", text);
	      form.append("email", currentEmail);
	      if (currentNickname) {
	        form.append("nickname", currentNickname);
	      }

	      try {
	        const res = await fetch(`/posts/${postId}/comments`, { method: "POST", body: form });
	        const data = await res.json().catch(() => ({}));

	        if (!res.ok) {
	          const msg = data.detail || "댓글 작성 중 오류가 발생했습니다.";
	          commentErrorEl.textContent = msg;
	          return;
	        }

	        newCommentText.value = "";
	        commentErrorEl.textContent = "";
	        await loadPostDetail();
	      } catch (err) {
	        console.error(err);
	        commentErrorEl.textContent = "네트워크 오류가 발생했습니다.";
	      }
	    });

    /* ============================
       댓글 수정
    ============================== */
    async function editComment(commentId, oldText) {
      const newText = prompt("댓글을 수정하세요:", oldText);
      if (newText === null) return;

      const trimmed = newText.trim();
      if (!trimmed) return alert("내용을 입력해주세요.");

      const form = new FormData();
      form.append("text", trimmed);

      try {
        const res = await fetch(`/posts/${postId}/comments/${commentId}`, {
          method: "PUT",
          body: form,
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) return alert(data.detail || "댓글 수정 중 오류가 발생했습니다.");

        await loadPostDetail();
      } catch (err) {
        console.error(err);
        alert("네트워크 오류가 발생했습니다.");
      }
    }

    /* ============================
       댓글 삭제 → 모달 실행
    ============================== */
    async function deleteComment(commentId) {
      openModal(
        "댓글을 삭제하시겠습니까?",
        "삭제한 내용은 복구할 수 없습니다",
        async () => {
          try {
            const res = await fetch(`/posts/${postId}/comments/${commentId}`, {
              method: "DELETE",
            });
            const data = await res.json().catch(() => ({}));

            if (!res.ok) return alert(data.detail || "댓글 삭제 중 오류가 발생했습니다.");

            await loadPostDetail();
          } catch (err) {
            console.error(err);
            alert("네트워크 오류가 발생했습니다.");
          }
        }
      );
    }
  </script>
</body>
</html>
