<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>회원가입 - 커뮤니티</title>
  <style>
    :root {
      --bg: #f3f7fd;
      --card-bg: #ffffff;
      --border-subtle: #dbe5f5;
      --primary: #7fb5ff;
      --primary-dark: #4f8fea;
      --primary-soft: #c3ddff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --error: #b91c1c;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 480px;
      margin: 40px auto;
      padding: 0 16px;
      line-height: 1.5;
      background-color: var(--bg);
      color: var(--text-main);
    }
    h1 { margin-bottom: 0.6rem; font-size: 24px; font-weight: 700; letter-spacing: 0.02em; }
    .small { font-size: 12px; color: var(--text-muted); }
    .card {
      background-color: var(--card-bg);
      border-radius: 18px;
      padding: 22px;
      margin-top: 16px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.10);
      border: 1px solid rgba(219, 229, 245, 0.9);
    }
    .input-row { margin-bottom: 10px; }
    .input-row label { display: block; margin-bottom: 4px; }
    .input-row input {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background-color: #f9fbff;
      outline: none;
    }
    .input-row input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(127, 181, 255, 0.4);
      background-color: #ffffff;
    }
    .avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 999px;
      background: #e0edff;
      border: 2px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    button {
      padding: 11px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background-color: #c3ddff;
      color: white;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 10px 25px rgba(79, 143, 234, 0.20);
      transition: background 0.15s ease, background-color 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
    }
    button.enabled {
      background: linear-gradient(135deg, #7fb5ff, #4f8fea);
      background-color: transparent;
    }
    button.enabled:hover {
      background: linear-gradient(135deg, #72a9ff, #437fe0);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(79, 143, 234, 0.35);
    }
    button:disabled { cursor: not-allowed; }
    .result {
      margin-top: 12px;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
    }
    .result.ok { background-color: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }
    .result.error { background-color: #fef2f2; color: var(--error); border: 1px solid #fecaca; }
    .error-text { font-size: 12px; color: var(--error); margin: 2px 0 6px; }
  </style>
</head>
<body>
  <div style="text-align:center; margin-bottom:4px; font-size:16px; font-weight:600; letter-spacing:0.04em; color:#6b7280;">
    AI Fashion Insight Engine
  </div>
  <div style="height:1px; background-color:#dbe5f5; margin-bottom:12px;"></div>
  <h1>회원가입</h1>

  <div class="card">
    <div class="avatar-preview" id="signup-avatar-preview">
      <span class="small">프로필</span>
    </div>
    <div class="input-row">
      <label class="small" for="signup-profile">프로필 사진</label><br />
      <input id="signup-profile" type="file" accept="image/*" style="display:none;" />
      <div id="profile-error" class="error-text"></div>
    </div>
    <div class="input-row">
      <label class="small" for="signup-email">이메일</label><br />
      <input id="signup-email" type="email" />
      <div id="email-error" class="error-text"></div>
    </div>
    <div class="input-row">
      <label class="small" for="signup-password">비밀번호</label><br />
      <input id="signup-password" type="password" />
      <div id="password-error" class="error-text"></div>
    </div>
    <div class="input-row">
      <label class="small" for="signup-password-check">비밀번호 확인</label><br />
      <input id="signup-password-check" type="password" />
      <div id="password-check-error" class="error-text"></div>
    </div>
    <div class="input-row">
      <label class="small" for="signup-nickname">닉네임</label><br />
      <input id="signup-nickname" type="text" />
      <div id="nickname-error" class="error-text"></div>
    </div>
    <button id="signup-btn" type="button" disabled>회원가입</button>
    <div id="signup-result" style="display:none;" class="result"></div>
  </div>

  <script>
    const apiBase = "";
    const emailPattern = /^[^@]+@[^@]+\.[^@]+$/;

    let hasProfile = false;

    const avatarPreview = document.getElementById("signup-avatar-preview");
    const profileInput = document.getElementById("signup-profile");
    const profileErrorEl = document.getElementById("profile-error");
    const emailInput = document.getElementById("signup-email");
    const emailErrorEl = document.getElementById("email-error");
    const passwordInput = document.getElementById("signup-password");
    const passwordErrorEl = document.getElementById("password-error");
    const passwordCheckInput = document.getElementById("signup-password-check");
    const passwordCheckErrorEl = document.getElementById("password-check-error");
    const nicknameInput = document.getElementById("signup-nickname");
    const nicknameErrorEl = document.getElementById("nickname-error");
    const signupBtn = document.getElementById("signup-btn");
    const signupResultEl = document.getElementById("signup-result");

    const appTitleEl = document.querySelector(".app-title");
    if (appTitleEl) {
      appTitleEl.style.cursor = "pointer";
      appTitleEl.addEventListener("click", () => {
        window.location.href = "/static/posts_list.html";
      });
    }


    avatarPreview.addEventListener("click", () => {
      if (!hasProfile) {
        profileInput.click();
      } else {
        // 토글로 삭제
        profileInput.value = "";
        avatarPreview.innerHTML = '<span class="small">프로필</span>';
        hasProfile = false;
        profileErrorEl.textContent = "프로필 사진을 추가해주세요";
        updateSignupButtonState();
      }
    });

    profileInput.addEventListener("change", () => {
      const file = profileInput.files[0];
      if (!file) {
        avatarPreview.innerHTML = '<span class="small">프로필</span>';
        hasProfile = false;
        profileErrorEl.textContent = "프로필 사진을 추가해주세요";
      } else {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        avatarPreview.innerHTML = "";
        avatarPreview.appendChild(img);
        hasProfile = true;
        profileErrorEl.textContent = "";
      }
      updateSignupButtonState();
    });

    function validateEmail() {
      const email = emailInput.value.trim();
      if (!email) {
        emailErrorEl.textContent = "이메일을 입력해주세요";
        return false;
      }
      if (email.length < 6 || !emailPattern.test(email)) {
        emailErrorEl.textContent = "올바른 이메일 주소 형식을 입력해주세요(예 : example@example.com)";
        return false;
      }
      emailErrorEl.textContent = "";
      return true;
    }

    function validatePassword() {
      const pw = passwordInput.value;
      if (!pw) {
        passwordErrorEl.textContent = "비밀번호를 입력해주세요";
        return false;
      }
      const cond =
        pw.length < 8 ||
        pw.length > 20 ||
        !/[A-Z]/.test(pw) ||
        !/[a-z]/.test(pw) ||
        !/[0-9]/.test(pw) ||
        !/[^A-Za-z0-9]/.test(pw);
      if (cond) {
        passwordErrorEl.textContent =
          "비밀번호는 8자 이상, 20자 이하이며, 대문자, 소문자, 숫자, 특수문자를 각각 최소 1개 포함해야 합니다.";
        return false;
      }
      passwordErrorEl.textContent = "";
      return true;
    }

    function validatePasswordCheck() {
      const pw = passwordInput.value;
      const pwCheck = passwordCheckInput.value;
      if (!pwCheck) {
        passwordCheckErrorEl.textContent = "비밀번호를 한번 더 입력해주세요";
        return false;
      }
      if (pw !== pwCheck) {
        passwordCheckErrorEl.textContent = "비밀번호가 다릅니다";
        return false;
      }
      passwordCheckErrorEl.textContent = "";
      return true;
    }

    function validateNickname() {
      const nickname = nicknameInput.value.trim();
      if (!nickname) {
        nicknameErrorEl.textContent = "닉네임을 입력해주세요";
        return false;
      }
      if (nickname.includes(" ")) {
        nicknameErrorEl.textContent = "띄어쓰기를 없에주세요";
        return false;
      }
      if (nickname.length > 10) {
        nicknameErrorEl.textContent = "닉네임은 최대 10자까지 작성 가능합니다.";
        return false;
      }
      nicknameErrorEl.textContent = "";
      return true;
    }

    function updateSignupButtonState() {
      const emailOk = validateEmail();
      const pwOk = validatePassword();
      const pwCheckOk = validatePasswordCheck();
      const nicknameOk = validateNickname();

      if (!hasProfile && emailOk && pwOk && pwCheckOk && nicknameOk) {
        profileErrorEl.textContent = "프로필 사진을 등록하세요";
      }

      const valid = hasProfile && emailOk && pwOk && pwCheckOk && nicknameOk;
      signupBtn.disabled = !valid;
      if (valid) {
        signupBtn.classList.add("enabled");
      } else {
        signupBtn.classList.remove("enabled");
      }
    }

    emailInput.addEventListener("blur", () => {
      validateEmail();
      updateSignupButtonState();
    });

    passwordInput.addEventListener("blur", () => {
      validatePassword();
      updateSignupButtonState();
    });

    passwordCheckInput.addEventListener("blur", () => {
      validatePasswordCheck();
      updateSignupButtonState();
    });

    nicknameInput.addEventListener("blur", () => {
      validateNickname();
      updateSignupButtonState();
    });

    // 회원가입 요청
    signupBtn.addEventListener("click", async () => {
      if (signupBtn.disabled) return;

      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const passwordCheck = passwordCheckInput.value;
      const nickname = nicknameInput.value.trim();
      const profileFile = profileInput.files[0] || null;

      const form = new FormData();
      form.append("email", email);
      form.append("password", password);
      form.append("password_check", passwordCheck);
      form.append("nickname", nickname);
      if (profileFile) form.append("profile", profileFile);

      try {
        const res = await fetch(apiBase + "/auth/signup", {
          method: "POST",
          body: form,
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          signupResultEl.style.display = "block";
          signupResultEl.className = "result error";

          let errorMessage = "회원가입 중 오류가 발생했습니다.";
          const detail = data && data.detail;

          if (detail) {
            if (typeof detail === "string") {
              errorMessage = detail;
            } else if (Array.isArray(detail) && detail.length > 0 && detail[0].msg) {
              // FastAPI validation error 형식 처리
              errorMessage = detail.map((d) => d.msg).join(", ");
            } else if (typeof detail === "object" && detail.msg) {
              errorMessage = detail.msg;
            }
          }

          signupResultEl.textContent = errorMessage;

          // 중복 이메일/닉네임/프로필 등의 서버 메시지도 아래에 반영
          if (typeof detail === "string") {
            if (detail === "프로필 사진을 추가해주세요") {
              profileErrorEl.textContent = detail;
            }
            if (detail.includes("이메일")) {
              emailErrorEl.textContent = detail;
            }
            if (detail.includes("닉네임")) {
              nicknameErrorEl.textContent = detail;
            }
            if (detail.includes("비밀번호")) {
              passwordErrorEl.textContent = detail;
            }
          }
          return;
        }
        signupResultEl.style.display = "block";
        signupResultEl.className = "result ok";
        signupResultEl.textContent = data.message || "회원가입이 완료되었습니다.";

        // 로그인 정보 및 프로필 이미지 로컬 저장
        if (email) {
          localStorage.setItem("currentEmail", email);
        }
        const nickname = nicknameInput.value.trim();
        if (nickname) {
          localStorage.setItem("currentNickname", nickname);
        }
        if (profileFile) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              localStorage.setItem("currentProfileImage", e.target.result);
            } catch (err) {
              console.error("프로필 이미지 저장 실패", err);
            }
            window.location.href = "/static/posts_list.html";
          };
          reader.readAsDataURL(profileFile);
        } else {
          window.location.href = "/static/posts_list.html";
        }
      } catch (err) {
        console.error(err);
        signupResultEl.style.display = "block";
        signupResultEl.className = "result error";
        signupResultEl.textContent = "네트워크 오류가 발생했습니다.";
      }
    });
  </script>
</body>
</html>
